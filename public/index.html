<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Family List</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f4f3f1; --surface:#fff; --surface2:#f9f8f7;
  --border:#e4e2de; --border2:#ccc9c3;
  --text:#181714; --mid:#6a6760; --soft:#aaa59f;
  --blue:#2563eb; --blue-bg:#eff6ff;
  --shadow:0 1px 4px rgba(0,0,0,.07),0 2px 8px rgba(0,0,0,.04);
  --shadow2:0 4px 16px rgba(0,0,0,.1);
  --r:10px; --rl:14px;
  --food:#dc2626;--food-bg:#fef2f2;
  --toys:#7c3aed;--toys-bg:#f5f3ff;
  --clothes:#d97706;--clothes-bg:#fffbeb;
  --school:#2563eb;--school-bg:#eff6ff;
  --house:#059669;--house-bg:#ecfdf5;
  --health:#db2777;--health-bg:#fdf2f8;
  --fun:#ea580c;--fun-bg:#fff7ed;
  --other:#64748b;--other-bg:#f8fafc;
  --urgent:#dc2626;--normal:#16a34a;--sometime:#94a3b8;
  --header-h:56px;
  --nav-h:60px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5;}

/* â•â•â• AUTH SCREEN â•â•â• */
#authScreen{
  position:fixed;inset:0;background:var(--bg);z-index:600;
  display:flex;align-items:center;justify-content:center;padding:1rem;
}
#authScreen.hidden{display:none;}
.auth-box{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);
  padding:2rem;max-width:380px;width:100%;box-shadow:var(--shadow2);
}
.auth-logo{font-size:28px;margin-bottom:.5rem;}
.auth-box h2{font-size:20px;font-weight:700;margin-bottom:4px;}
.auth-box p{font-size:13px;color:var(--mid);margin-bottom:1.5rem;line-height:1.6;}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:var(--r);margin-bottom:1.5rem;overflow:hidden;}
.auth-tab{flex:1;padding:8px;background:transparent;border:none;font-family:inherit;font-size:13px;font-weight:600;color:var(--soft);cursor:pointer;transition:all .12s;}
.auth-tab.active{background:var(--text);color:#fff;}
.auth-field{margin-bottom:.875rem;}
.auth-field label{display:block;font-size:11px;font-weight:600;color:var(--mid);margin-bottom:4px;}
.auth-field input{width:100%;border:1px solid var(--border);border-radius:var(--r);padding:9px 12px;font-family:inherit;font-size:13px;color:var(--text);background:var(--surface2);outline:none;transition:border-color .12s,box-shadow .12s;}
.auth-field input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.08);background:var(--surface);}
.auth-submit{width:100%;padding:10px;background:var(--blue);color:#fff;border:none;border-radius:var(--r);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:background .12s;margin-top:.25rem;}
.auth-submit:hover{background:#1d4ed8;}
.auth-submit:disabled{opacity:.5;cursor:not-allowed;}
.auth-err{font-size:12px;color:#dc2626;background:#fef2f2;border:1px solid #fecaca;border-radius:7px;padding:7px 10px;margin-bottom:.875rem;display:none;}
.auth-err.show{display:block;}

/* â•â•â• FAMILY SCREEN â•â•â• */
#familyScreen{
  position:fixed;inset:0;background:var(--bg);z-index:550;
  display:flex;align-items:center;justify-content:center;padding:1rem;
}
#familyScreen.hidden{display:none;}
.fam-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);padding:2rem;max-width:400px;width:100%;box-shadow:var(--shadow2);}
.fam-logo{font-size:28px;margin-bottom:.5rem;}
.fam-box h2{font-size:18px;font-weight:700;margin-bottom:4px;}
.fam-box p{font-size:13px;color:var(--mid);margin-bottom:1.5rem;line-height:1.6;}
.fam-tabs{display:flex;border:1px solid var(--border);border-radius:var(--r);margin-bottom:1.5rem;overflow:hidden;}
.fam-tab{flex:1;padding:8px;background:transparent;border:none;font-family:inherit;font-size:13px;font-weight:600;color:var(--soft);cursor:pointer;transition:all .12s;}
.fam-tab.active{background:var(--text);color:#fff;}
.fam-panel{display:none;}
.fam-panel.active{display:block;}
.fam-field{margin-bottom:.875rem;}
.fam-field label{display:block;font-size:11px;font-weight:600;color:var(--mid);margin-bottom:4px;}
.fam-field input{width:100%;border:1px solid var(--border);border-radius:var(--r);padding:9px 12px;font-family:inherit;font-size:13px;color:var(--text);background:var(--surface2);outline:none;transition:border-color .12s;}
.fam-field input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.08);background:var(--surface);}
.fam-field .hint{font-size:11px;color:var(--soft);margin-top:3px;}
.fam-submit{width:100%;padding:10px;background:var(--blue);color:#fff;border:none;border-radius:var(--r);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:background .12s;}
.fam-submit:hover{background:#1d4ed8;}
.fam-submit:disabled{opacity:.5;cursor:not-allowed;}
.fam-err{font-size:12px;color:#dc2626;background:#fef2f2;border:1px solid #fecaca;border-radius:7px;padding:7px 10px;margin-bottom:.875rem;display:none;}
.fam-err.show{display:block;}

/* â•â•â• MODAL â•â•â• */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);z-index:500;display:flex;align-items:center;justify-content:center;padding:1rem;}
.overlay.hidden{display:none;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);padding:1.5rem;max-width:320px;width:100%;box-shadow:var(--shadow2);}
.modal-icon{font-size:24px;margin-bottom:.5rem;}
.modal-title{font-size:15px;font-weight:700;margin-bottom:4px;}
.modal-body{font-size:13px;color:var(--mid);margin-bottom:1.25rem;line-height:1.6;}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:var(--r);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .12s;border:1px solid transparent;}
.btn-ghost{background:transparent;border-color:var(--border);color:var(--mid);}
.btn-ghost:hover{background:var(--bg);color:var(--text);}
.btn-danger{background:#dc2626;color:#fff;}
.btn-danger:hover{background:#b91c1c;}
.btn-primary{background:var(--blue);color:#fff;}
.btn-primary:hover{background:#1d4ed8;}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}

/* â•â•â• ACCOUNT MENU â•â•â• */
#accountMenu{
  position:fixed;top:calc(var(--header-h) + 6px);right:1rem;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);
  padding:1rem;min-width:240px;box-shadow:var(--shadow2);z-index:300;
  display:none;
}
#accountMenu.open{display:block;}
.am-name{font-size:14px;font-weight:700;margin-bottom:2px;}
.am-email{font-size:12px;color:var(--soft);margin-bottom:.75rem;}
.am-fam{background:var(--blue-bg);border:1px solid #bfdbfe;border-radius:8px;padding:9px 11px;margin-bottom:.75rem;}
.am-fam-name{font-size:13px;font-weight:600;color:var(--blue);}
.am-fam-code{font-size:11px;color:var(--mid);margin-top:2px;}
.am-code-val{font-family:monospace;font-size:13px;font-weight:700;letter-spacing:.05em;background:#fff;border:1px solid #bfdbfe;border-radius:5px;padding:2px 7px;color:var(--blue);}
.am-row{display:flex;gap:6px;margin-bottom:6px;}
.am-btn{flex:1;padding:7px 10px;border-radius:var(--r);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .12s;border:1px solid var(--border);background:var(--surface2);color:var(--mid);}
.am-btn:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-bg);}
.am-btn.danger:hover{border-color:#dc2626;color:#dc2626;background:#fef2f2;}
.am-member{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid #e8f0fe;font-size:12px;}
.am-member:last-child{border-bottom:none;}
.am-member-name{flex:1;font-weight:600;color:var(--text);}
.am-member-you{font-size:10px;color:var(--blue);font-weight:600;background:var(--blue-bg);padding:1px 5px;border-radius:4px;}
.am-member-kick{background:none;border:none;cursor:pointer;color:#dc2626;font-size:11px;font-weight:600;padding:2px 6px;border-radius:4px;transition:background .1s;}
.am-member-kick:hover{background:#fef2f2;}
#kickedOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:700;display:none;align-items:center;justify-content:center;padding:1rem;}
#kickedOverlay.show{display:flex;}
.kicked-box{background:var(--surface);border-radius:var(--rl);padding:2rem;max-width:320px;width:100%;text-align:center;box-shadow:var(--shadow2);}
.kicked-box .k-icon{font-size:36px;margin-bottom:.5rem;}
.kicked-box h3{font-size:16px;font-weight:700;margin-bottom:.5rem;}
.kicked-box p{font-size:13px;color:var(--mid);margin-bottom:1.25rem;}

/* â•â•â• HEADER â•â•â• */
header{position:fixed;top:0;left:0;right:0;z-index:100;height:var(--header-h);background:rgba(255,255,255,.94);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 1.25rem;}
.h-brand{font-size:16px;font-weight:700;letter-spacing:-.2px;}
.h-right{display:flex;align-items:center;gap:8px;}
.h-badge{background:var(--blue);color:#fff;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
.h-user{display:flex;align-items:center;gap:5px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 10px;font-size:12px;font-weight:600;color:var(--mid);cursor:pointer;transition:all .12s;}
.h-user:hover{border-color:var(--blue);color:var(--blue);}
.h-sub{font-size:11px;color:var(--soft);margin-top:1px;}

/* â•â•â• DESKTOP LAYOUT â•â•â• */
.app-shell{position:fixed;top:var(--header-h);left:0;right:0;bottom:0;display:flex;}
.sidebar{width:320px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;}
.sb-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;position:sticky;top:0;z-index:2;background:var(--surface);}
.sb-tab{flex:1;padding:11px 6px;border:none;background:transparent;font-family:inherit;font-size:12px;font-weight:600;color:var(--soft);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .12s;}
.sb-tab.active{color:var(--blue);border-bottom-color:var(--blue);}
.sb-panel{display:none;padding:1.125rem;flex:1;}
.sb-panel.active{display:block;}
.main{flex:1;min-width:0;overflow-y:auto;overflow-x:hidden;padding:1.25rem 1.5rem;background:var(--bg);}

/* â•â•â• FORM FIELDS â•â•â• */
.field{margin-bottom:.8rem;}
.field label{display:block;font-size:10px;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;}
.field input,.field textarea,.field select{width:100%;border:1px solid var(--border);border-radius:var(--r);padding:7px 10px;font-family:inherit;font-size:13px;color:var(--text);background:var(--surface2);outline:none;transition:border-color .12s,box-shadow .12s;}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.08);background:var(--surface);}
.field textarea{resize:vertical;min-height:55px;line-height:1.5;}
.field input[readonly]{background:var(--blue-bg);color:var(--blue);font-weight:600;cursor:default;border-color:transparent;}

.cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;}
.cat-btn{display:flex;flex-direction:column;align-items:center;padding:6px 2px;border:1px solid var(--border);border-radius:var(--r);background:var(--surface2);cursor:pointer;font-family:inherit;font-size:10px;font-weight:600;color:var(--soft);transition:all .12s;gap:2px;}
.cat-btn span{font-size:16px;}
.cat-btn:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-bg);}
.cat-btn.sc-food{border-color:var(--food);background:var(--food-bg);color:var(--food);}
.cat-btn.sc-toys{border-color:var(--toys);background:var(--toys-bg);color:var(--toys);}
.cat-btn.sc-clothes{border-color:var(--clothes);background:var(--clothes-bg);color:var(--clothes);}
.cat-btn.sc-school{border-color:var(--school);background:var(--school-bg);color:var(--school);}
.cat-btn.sc-house{border-color:var(--house);background:var(--house-bg);color:var(--house);}
.cat-btn.sc-health{border-color:var(--health);background:var(--health-bg);color:var(--health);}
.cat-btn.sc-fun{border-color:var(--fun);background:var(--fun-bg);color:var(--fun);}
.cat-btn.sc-other{border-color:var(--other);background:var(--other-bg);color:var(--other);}

.urg-row{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;}
.urg-btn{padding:7px 4px;border:1px solid var(--border);border-radius:var(--r);background:var(--surface2);font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;color:var(--soft);transition:all .12s;}
.urg-btn:hover{border-color:var(--blue);color:var(--blue);}
.urg-btn.su-urgent{border-color:var(--urgent);background:#fef2f2;color:var(--urgent);}
.urg-btn.su-normal{border-color:var(--normal);background:#f0fdf4;color:var(--normal);}
.urg-btn.su-sometime{border-color:var(--sometime);background:#f8fafc;color:var(--sometime);}

.add-btn{width:100%;padding:9px;background:var(--blue);color:#fff;border:none;border-radius:var(--r);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .12s;margin-top:.25rem;}
.add-btn:hover{background:#1d4ed8;}
.add-btn:disabled{opacity:.5;cursor:not-allowed;}

/* â•â•â• LISTS TAB â•â•â• */
.sec-label{font-size:10px;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.5rem;}
.tpl-name{width:100%;border:1px solid var(--border);border-radius:var(--r);padding:7px 10px;font-family:inherit;font-size:13px;font-weight:600;color:var(--text);background:var(--surface2);outline:none;margin-bottom:.6rem;}
.tpl-name:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.08);}
.tpl-area{border:1px solid var(--border);border-radius:var(--r);background:var(--surface2);min-height:52px;padding:5px;display:flex;flex-direction:column;gap:4px;margin-bottom:.6rem;max-height:180px;overflow-y:auto;}
.tpl-empty{text-align:center;color:var(--soft);font-size:12px;padding:.75rem 0;}
.ti-row{background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:5px 6px;}
.ti-top{display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:4px;}
.ti-top input{border:none;background:transparent;font-family:inherit;font-size:13px;font-weight:500;color:var(--text);outline:none;min-width:0;padding:1px 3px;border-radius:4px;}
.ti-top input:focus{background:var(--bg);}
.ti-top select{border:1px solid var(--border);border-radius:5px;background:var(--surface2);font-family:inherit;font-size:10px;color:var(--mid);padding:2px 2px;outline:none;cursor:pointer;}
.ti-note-inp{width:100%;border:none;background:transparent;font-family:inherit;font-size:11px;color:var(--soft);outline:none;padding:1px 4px;}
.ti-note-inp::placeholder{color:var(--soft);}
.ti-del{background:none;border:none;cursor:pointer;color:var(--soft);font-size:13px;padding:2px 4px;border-radius:4px;transition:all .1s;line-height:1;}
.ti-del:hover{color:#dc2626;background:#fef2f2;}
.ti-adder{display:flex;flex-direction:column;gap:4px;margin-bottom:.6rem;}
.ti-adder input,.ti-adder textarea{width:100%;border:1px solid var(--border);border-radius:var(--r);padding:7px 10px;font-family:inherit;font-size:13px;color:var(--text);background:var(--surface2);outline:none;}
.ti-adder input:focus,.ti-adder textarea:focus{border-color:var(--blue);}
.ti-adder textarea{resize:none;line-height:1.4;}
.ti-r2{display:flex;gap:4px;}
.ti-r2 select{flex:1;border:1px solid var(--border);border-radius:var(--r);padding:7px 5px;font-family:inherit;font-size:12px;color:var(--mid);background:var(--surface2);outline:none;cursor:pointer;}
.ti-r2 select:focus{border-color:var(--blue);}
.ti-r2 .ti-add-btn{flex-shrink:0;padding:7px 13px;background:var(--text);color:#fff;border:none;border-radius:var(--r);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .12s;}
.ti-r2 .ti-add-btn:hover{background:var(--blue);}
.save-list-btn{width:100%;padding:8px;background:var(--text);color:#fff;border:none;border-radius:var(--r);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .12s;margin-bottom:.875rem;}
.save-list-btn:hover{background:var(--blue);}
.divider{height:1px;background:var(--border);margin:.75rem 0;}
.saved-cards{display:flex;flex-direction:column;gap:5px;}
.sc-card{border:1px solid var(--border);border-radius:var(--r);background:var(--surface2);overflow:hidden;}
.sc-head{display:flex;align-items:center;gap:6px;padding:8px 10px;flex-wrap:wrap;}
.sc-name{flex:1;font-size:13px;font-weight:600;min-width:0;}
.sc-cnt{font-size:11px;color:var(--soft);flex-shrink:0;}
.sc-acts{display:flex;gap:3px;flex-shrink:0;}
.sc-b{padding:4px 8px;border-radius:6px;font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .12s;border:1px solid transparent;}
.sc-b-add{background:var(--blue);color:#fff;}
.sc-b-add:hover{background:#1d4ed8;}
.sc-b-add:disabled{opacity:.5;cursor:not-allowed;}
.sc-b-edit{background:var(--surface);border-color:var(--border);color:var(--mid);}
.sc-b-edit:hover{border-color:var(--blue);color:var(--blue);}
.sc-b-del{background:var(--surface);border-color:var(--border);color:var(--soft);}
.sc-b-del:hover{border-color:#dc2626;color:#dc2626;background:#fef2f2;}
.sc-b-tog{background:none;border:1px solid var(--border);color:var(--soft);font-size:11px;}
.sc-b-tog:hover{background:var(--bg);}
.sc-preview{display:none;border-top:1px solid var(--border);background:var(--surface);}
.sc-pi{display:flex;align-items:center;gap:7px;padding:5px 10px;font-size:12px;color:var(--mid);border-bottom:1px solid var(--border);}
.sc-pi:last-child{border-bottom:none;}
.sc-pi-name{flex:1;font-weight:500;color:var(--text);}
.no-saved{font-size:12px;color:var(--soft);text-align:center;padding:.75rem 0;}

/* â•â•â• MAIN â•â•â• */
.filter-row{display:flex;gap:5px;overflow-x:auto;scrollbar-width:none;margin-bottom:.875rem;padding-bottom:2px;}
.filter-row::-webkit-scrollbar{display:none;}
.f-chip{flex-shrink:0;padding:5px 11px;border:1px solid var(--border);border-radius:20px;background:var(--surface);font-family:inherit;font-size:12px;font-weight:500;cursor:pointer;color:var(--mid);transition:all .12s;white-space:nowrap;}
.f-chip:hover{border-color:var(--border2);}
.f-chip.active{background:var(--text);color:#fff;border-color:var(--text);}
.f-chip.list-chip.active{background:var(--blue);border-color:var(--blue);}
.list-filter-row{display:flex;gap:5px;overflow-x:auto;scrollbar-width:none;margin-bottom:.75rem;padding-bottom:2px;align-items:center;}
.list-filter-row::-webkit-scrollbar{display:none;}
.lf-label{font-size:10px;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;flex-shrink:0;}
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem;gap:8px;}
.result-info{font-size:12px;color:var(--soft);font-weight:500;}
.clear-btn{padding:5px 10px;border:1px solid var(--border);border-radius:var(--r);background:var(--surface);font-family:inherit;font-size:12px;font-weight:500;color:var(--mid);cursor:pointer;transition:all .12s;}
.clear-btn:hover{border-color:#dc2626;color:#dc2626;background:#fef2f2;}
.items-list{display:flex;flex-direction:column;gap:5px;}
.item-card{background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--border);border-radius:var(--rl);padding:11px 13px;display:flex;align-items:flex-start;gap:10px;transition:all .15s;box-shadow:var(--shadow);}
.item-card:hover{box-shadow:var(--shadow2);transform:translateY(-1px);}
.item-card.done{opacity:.4;}
.item-card.done .ic-name{text-decoration:line-through;}
.item-card.ul-urgent{border-left-color:var(--urgent);}
.item-card.ul-normal{border-left-color:var(--normal);}
.item-card.ul-sometime{border-left-color:var(--sometime);}
.item-card.editing{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.08);}
@keyframes popIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}
.item-card{animation:popIn .15s ease;}
.chk{width:18px;height:18px;border-radius:4px;border:1.5px solid var(--border2);background:transparent;cursor:pointer;flex-shrink:0;transition:all .12s;display:flex;align-items:center;justify-content:center;font-size:11px;margin-top:2px;}
.chk:hover{border-color:var(--normal);background:#f0fdf4;}
.chk.on{background:var(--normal);border-color:var(--normal);color:#fff;}
.ic-body{flex:1;min-width:0;}
.ic-top{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:2px;}
.ic-name{font-size:14px;font-weight:600;flex:1;min-width:0;}
.cat-tag{font-size:10px;font-weight:600;padding:1px 7px;border-radius:20px;flex-shrink:0;}
.ct-food{background:var(--food-bg);color:var(--food);}
.ct-toys{background:var(--toys-bg);color:var(--toys);}
.ct-clothes{background:var(--clothes-bg);color:var(--clothes);}
.ct-school{background:var(--school-bg);color:var(--school);}
.ct-house{background:var(--house-bg);color:var(--house);}
.ct-health{background:var(--health-bg);color:var(--health);}
.ct-fun{background:var(--fun-bg);color:var(--fun);}
.ct-other{background:var(--other-bg);color:var(--other);}
.urg-tag{font-size:10px;font-weight:600;padding:1px 7px;border-radius:20px;flex-shrink:0;}
.ut-urgent{background:#fef2f2;color:var(--urgent);}
.ut-normal{background:#f0fdf4;color:var(--normal);}
.ut-sometime{background:#f8fafc;color:var(--sometime);}
.ic-note{font-size:12px;color:var(--mid);margin-top:2px;line-height:1.5;}
.ic-meta{font-size:11px;color:var(--soft);margin-top:3px;display:flex;gap:6px;}
.ic-acts{display:flex;gap:1px;flex-shrink:0;}
.ia{background:none;border:none;cursor:pointer;color:var(--soft);font-size:13px;padding:3px 5px;border-radius:5px;transition:all .12s;line-height:1;}
.ia:hover{background:var(--bg);color:var(--text);}
.ia.del:hover{background:#fef2f2;color:#dc2626;}
.ic-edit{flex:1;display:flex;flex-direction:column;gap:5px;}
.ic-edit input,.ic-edit textarea,.ic-edit select{border:1px solid var(--border);border-radius:7px;padding:6px 9px;font-family:inherit;font-size:13px;color:var(--text);background:var(--surface2);outline:none;width:100%;}
.ic-edit input:focus,.ic-edit textarea:focus,.ic-edit select:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(37,99,235,.08);}
.ic-edit textarea{resize:none;min-height:44px;}
.ic-edit-row{display:flex;gap:5px;}
.ic-edit-row select{flex:1;}
.ic-edit-acts{display:flex;gap:5px;justify-content:flex-end;}
.empty{text-align:center;padding:4rem 2rem;color:var(--soft);}
.empty-icon{font-size:36px;margin-bottom:.5rem;opacity:.4;}
.empty-title{font-size:15px;font-weight:600;color:var(--mid);margin-bottom:3px;}
.empty-sub{font-size:13px;}

/* no family placeholder */
.no-family-banner{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);padding:2rem;text-align:center;margin:2rem auto;max-width:400px;}
.no-family-banner .nf-icon{font-size:36px;margin-bottom:.5rem;}
.no-family-banner h3{font-size:16px;font-weight:700;margin-bottom:.4rem;}
.no-family-banner p{font-size:13px;color:var(--mid);margin-bottom:1.25rem;line-height:1.6;}
.no-family-banner .btn{margin:0 auto;}

/* Toast */
.toast{position:fixed;bottom:1.25rem;right:1.25rem;background:var(--text);color:#fff;padding:9px 15px;border-radius:var(--r);font-size:13px;font-weight:500;z-index:999;box-shadow:var(--shadow2);}
@keyframes toastIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
.toast{animation:toastIn .15s ease;}

/* â•â•â• LANG TOGGLE â•â•â• */
.lang-toggle{display:flex;gap:4px;margin-bottom:1.25rem;}
.lang-btn{flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:12px;font-weight:600;color:var(--soft);background:var(--surface2);cursor:pointer;transition:all .12s;}
.lang-btn:hover{border-color:var(--blue);color:var(--blue);}
.lang-btn.active{background:var(--text);color:#fff;border-color:var(--text);}
.h-lang{display:flex;gap:4px;align-items:center;}
.h-lang-btn{padding:3px 8px;border:1px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:11px;font-weight:600;color:var(--soft);background:transparent;cursor:pointer;transition:all .12s;}
.h-lang-btn:hover{border-color:var(--blue);color:var(--blue);}
.h-lang-btn.active{background:var(--text);color:#fff;border-color:var(--text);}

/* â•â•â• RTL support â•â•â• */
[dir="rtl"] .auth-box,[dir="rtl"] .fam-box{text-align:right;}
[dir="rtl"] .modal-btns{justify-content:flex-start;}
[dir="rtl"] .ic-meta{flex-direction:row-reverse;}
[dir="rtl"] .ic-top{flex-direction:row-reverse;}
[dir="rtl"] .ic-acts{flex-direction:row-reverse;}
[dir="rtl"] .ic-edit-acts{justify-content:flex-start;}
[dir="rtl"] .am-fam-code{text-align:right;}
[dir="rtl"] .toolbar{flex-direction:row-reverse;}
[dir="rtl"] .h-right{flex-direction:row-reverse;}
[dir="rtl"] .toast{right:auto;left:1.25rem;}
[dir="rtl"] .item-card{border-left:none;border-right:3px solid var(--border);}
[dir="rtl"] .item-card.ul-urgent{border-right-color:var(--urgent);}
[dir="rtl"] .item-card.ul-normal{border-right-color:var(--normal);}
[dir="rtl"] .item-card.ul-sometime{border-right-color:var(--sometime);}
[dir="rtl"] header{flex-direction:row-reverse;}
[dir="rtl"] .sb-panel{text-align:right;}
[dir="rtl"] .fam-field .hint{text-align:right;}
[dir="rtl"] .auth-field label,[dir="rtl"] .fam-field label{text-align:right;}
[dir="rtl"] .field label{text-align:right;}
@media(max-width:700px){
  [dir="rtl"] .toast{right:auto;left:.875rem;bottom:calc(var(--nav-h) + 10px);}
  [dir="rtl"] #accountMenu{left:1rem;right:1rem;}
}

/* â•â•â• MOBILE â•â•â• */
.mobile-nav{display:none;}
@media(max-width:700px){
  .app-shell{position:static;display:block;}
  body{padding-top:var(--header-h);padding-bottom:var(--nav-h);}
  .sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border);overflow:visible;display:none;background:var(--surface);}
  .sb-tabs{top:0;}
  .main{padding:.875rem 1rem;overflow:visible;}
  body.show-add .sidebar{display:block;}
  body.show-add .main{display:none;}
  body.show-lists .sidebar{display:block;}
  body.show-lists .main{display:none;}
  .mobile-nav{display:flex;position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);background:rgba(255,255,255,.97);backdrop-filter:blur(12px);border-top:1px solid var(--border);z-index:200;}
  .mn-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:none;border:none;cursor:pointer;font-family:inherit;font-size:10px;font-weight:600;color:var(--soft);border-top:2px solid transparent;padding:6px 0;transition:color .12s;-webkit-tap-highlight-color:transparent;}
  .mn-btn svg{width:20px;height:20px;}
  .mn-btn.active{color:var(--blue);border-top-color:var(--blue);}
  .chk{width:36px;height:36px;min-width:36px;min-height:36px;}
  header{height:var(--header-h);padding:0 1rem;}
  .h-sub{display:none;}
  .h-brand{font-size:15px;}
  .h-user{font-size:11px;padding:4px 9px;}
  .item-card{padding:10px 11px;gap:9px;}
  .ic-name{font-size:13px;}
  .filter-row{margin-bottom:.75rem;}
  .sc-head{flex-wrap:wrap;row-gap:5px;}
  .sc-acts{flex-wrap:wrap;}
  .toast{bottom:calc(var(--nav-h) + 10px);right:.875rem;left:.875rem;text-align:center;}
  #accountMenu{left:1rem;right:1rem;top:calc(var(--header-h) + 6px);}
}
</style>
</head>
<body>

<!-- â•â•â• AUTH SCREEN â•â•â• -->
<div id="authScreen" class="hidden">
  <div class="auth-box">
    <div class="lang-toggle">
      <button class="lang-btn active" id="authLangEN" onclick="setLang('en')">English</button>
      <button class="lang-btn" id="authLangHE" onclick="setLang('he')">×¢×‘×¨×™×ª</button>
    </div>
    <div class="auth-logo">ğŸ </div>
    <h2 id="authTitle">Family List</h2>
    <p id="authSubtitle">Your shared family shopping &amp; to-do list. Sign up or log in to get started.</p>
    <div class="auth-tabs">
      <button class="auth-tab active" id="authTabLogin" onclick="authTab('login')">Log In</button>
      <button class="auth-tab" id="authTabSignup" onclick="authTab('signup')">Sign Up</button>
    </div>
    <!-- Login form -->
    <div id="authPanelLogin">
      <div class="auth-err" id="loginErr"></div>
      <div class="auth-field"><label id="lblLoginEmail">Email</label><input id="loginEmail" type="email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="auth-field"><label id="lblLoginPwd">Password</label><input id="loginPwd" type="password" placeholder="Your password" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="auth-submit" id="loginBtn" onclick="doLogin()">Log In</button>
    </div>
    <!-- Signup form -->
    <div id="authPanelSignup" style="display:none;">
      <div class="auth-err" id="signupErr"></div>
      <div class="auth-field"><label id="lblSignupName">Your Name</label><input id="signupName" type="text" placeholder="e.g. Sarah" maxlength="40" onkeydown="if(event.key==='Enter')doSignup()"></div>
      <div class="auth-field"><label id="lblSignupEmail">Email</label><input id="signupEmail" type="email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doSignup()"></div>
      <div class="auth-field"><label id="lblSignupPwd">Password <span style="font-weight:400;text-transform:none;letter-spacing:0;" id="lblSignupPwdHint">(min 6 characters)</span></label><input id="signupPwd" type="password" placeholder="Create a password" onkeydown="if(event.key==='Enter')doSignup()"></div>
      <button class="auth-submit" id="signupBtn" onclick="doSignup()">Create Account</button>
    </div>
  </div>
</div>

<!-- â•â•â• FAMILY SCREEN â•â•â• -->
<div id="familyScreen" class="hidden">
  <div class="fam-box">
    <!-- Success screen shown after creating -->
    <div id="famSuccess" style="display:none;text-align:center;">
      <div style="font-size:36px;margin-bottom:.5rem;">ğŸ‰</div>
      <h2 style="font-size:18px;font-weight:700;margin-bottom:.5rem;" id="famSuccessTitle">Family Created!</h2>
      <p style="font-size:13px;color:var(--mid);margin-bottom:1.25rem;" id="famSuccessMsg">Share this invite code with your family members so they can join:</p>
      <div id="famSuccessCode" style="font-family:monospace;font-size:32px;font-weight:800;letter-spacing:.1em;color:var(--blue);background:var(--blue-bg);border:2px solid #bfdbfe;border-radius:var(--rl);padding:1rem;margin-bottom:1rem;"></div>
      <p style="font-size:12px;color:var(--soft);margin-bottom:1.5rem;" id="famSuccessHint">They go to "Join Family" and enter this code.</p>
      <button class="fam-submit" id="famSuccessBtn" onclick="closeFamilyScreen()">Go to My List â†’</button>
    </div>
    <!-- Normal screen -->
    <div id="famMain">
      <div class="fam-logo">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
      <h2 id="famTitle">Join or Create a Family</h2>
      <p id="famSubtitle">Create a new family list and share the invite code, or join an existing one.</p>
      <div class="fam-tabs">
        <button class="fam-tab active" id="famTabCreate" onclick="famTab('create')">Create Family</button>
        <button class="fam-tab" id="famTabJoin" onclick="famTab('join')">Join Family</button>
      </div>
      <!-- Create -->
      <div class="fam-panel active" id="famPanelCreate">
        <div class="fam-err" id="createErr"></div>
        <div class="fam-field">
          <label id="lblFamName">Family Name</label>
          <input id="famName" type="text" placeholder="e.g. The Smiths" maxlength="40" onkeydown="if(event.key==='Enter')doCreateFamily()">
          <div class="hint" id="hintFamName">This is the name your family members will see.</div>
        </div>
        <button class="fam-submit" id="createFamBtn" onclick="doCreateFamily()">Create Family</button>
      </div>
      <!-- Join -->
      <div class="fam-panel" id="famPanelJoin">
        <div class="fam-err" id="joinErr"></div>
        <div class="fam-field">
          <label id="lblJoinName">Family Name</label>
          <input id="joinName" type="text" placeholder="e.g. The Smiths" maxlength="40" onkeydown="if(event.key==='Enter')doJoinFamily()">
          <div class="hint" id="hintJoinName">The name of the family you're joining.</div>
        </div>
        <div class="fam-field">
          <label id="lblJoinCode">Invite Code</label>
          <input id="joinCode" type="text" placeholder="e.g. BLUE-7492" maxlength="10" style="text-transform:uppercase;font-family:monospace;font-size:16px;font-weight:700;letter-spacing:.05em;" onkeydown="if(event.key==='Enter')doJoinFamily()">
          <div class="hint" id="hintJoinCode">Ask your family member for their invite code.</div>
        </div>
        <button class="fam-submit" id="joinFamBtn" onclick="doJoinFamily()">Join Family</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• CONFIRM MODAL â•â•â• -->
<div class="overlay hidden" id="confirmModal">
  <div class="modal">
    <div class="modal-icon" id="mIcon">ğŸ—‘</div>
    <div class="modal-title" id="mTitle">Are you sure?</div>
    <div class="modal-body" id="mBody">This cannot be undone.</div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" id="mConfirmBtn">Delete</button>
    </div>
  </div>
</div>

<!-- â•â•â• ACCOUNT MENU â•â•â• -->
<div id="accountMenu">
  <div class="am-name" id="amName">â€”</div>
  <div class="am-email" id="amEmail">â€”</div>
  <div id="amFamBlock" class="am-fam" style="display:none;">
    <div class="am-fam-name" id="amFamName">â€”</div>
    <div class="am-fam-code"><span id="amInviteLabel">Invite code:</span> <span class="am-code-val" id="amFamCode">â€”</span></div>
    <!-- Admin panel: members list (owner only) -->
    <div id="amMembersBlock" style="display:none;margin-top:.75rem;">
      <div style="font-size:10px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.4rem;">ğŸ‘‘ Members</div>
      <div id="amMembersList"></div>
      <button class="am-btn danger" style="width:100%;margin-top:.5rem;" onclick="adminDeleteAllItems()">ğŸ—‘ Delete All Items</button>
    </div>
  </div>
  <div id="amNoFam" style="font-size:12px;color:var(--soft);margin-bottom:.75rem;display:none;">Not in a family yet.</div>
  <div class="am-row">
    <button class="am-btn" id="amFamBtn" onclick="leaveFamilyThenOpen()">Family Settings</button>
    <button class="am-btn danger" id="amLogoutBtn" onclick="doLogout()">Log Out</button>
  </div>
</div>

<!-- â•â•â• KICKED OVERLAY â•â•â• -->
<div id="kickedOverlay">
  <div class="kicked-box">
    <div class="k-icon">ğŸ‘‹</div>
    <h3 id="kickedTitle">You've been removed</h3>
    <p id="kickedMsg">You are no longer in this family.</p>
    <button class="fam-submit" id="kickedOkBtn" onclick="handleKicked()">OK</button>
  </div>
</div>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div>
    <div class="h-brand">ğŸ  Family List</div>
    <div class="h-sub" id="hSub">â€¦</div>
  </div>
  <div class="h-right">
    <div class="h-lang">
      <button class="h-lang-btn" id="hLangEN" onclick="setLang('en')">EN</button>
      <button class="h-lang-btn" id="hLangHE" onclick="setLang('he')">×¢×‘</button>
    </div>
    <span class="h-badge" id="hCount">0</span>
    <button class="h-user" onclick="toggleAccountMenu()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
      </svg>
      <span id="hUser">â€¦</span>
    </button>
  </div>
</header>

<!-- â•â•â• APP SHELL â•â•â• -->
<div class="app-shell">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sb-tabs">
      <button class="sb-tab active" id="sbTabAdd"   onclick="sbTab('add')" data-i18n="addItem">Add Item</button>
      <button class="sb-tab"        id="sbTabLists" onclick="sbTab('lists')" data-i18n="myLists">My Lists</button>
    </div>

    <!-- ADD ITEM panel -->
    <div class="sb-panel active" id="sbPanelAdd">
      <div class="field"><label id="lblAddedBy">Added by</label><input id="fWho" readonly></div>
      <div class="field">
        <label id="lblItemName">Item name</label>
        <input id="fName" placeholder="e.g. Milk, Batteries, Shampooâ€¦" maxlength="80">
      </div>
      <div class="field">
        <label id="lblCategory">Category</label>
        <div class="cat-grid" id="catGrid">
          <button class="cat-btn" data-cat="food"    onclick="pickCat(this)"><span>ğŸ›’</span><span data-i18n="food">Food</span></button>
          <button class="cat-btn" data-cat="toys"    onclick="pickCat(this)"><span>ğŸ§¸</span><span data-i18n="toys">Toys</span></button>
          <button class="cat-btn" data-cat="clothes" onclick="pickCat(this)"><span>ğŸ‘•</span><span data-i18n="clothes">Clothes</span></button>
          <button class="cat-btn" data-cat="school"  onclick="pickCat(this)"><span>ğŸ’</span><span data-i18n="school">School</span></button>
          <button class="cat-btn" data-cat="house"   onclick="pickCat(this)"><span>ğŸ¡</span><span data-i18n="house">House</span></button>
          <button class="cat-btn" data-cat="health"  onclick="pickCat(this)"><span>ğŸ’Š</span><span data-i18n="health">Health</span></button>
          <button class="cat-btn" data-cat="fun"     onclick="pickCat(this)"><span>ğŸ‰</span><span data-i18n="fun">Fun</span></button>
          <button class="cat-btn" data-cat="other"   onclick="pickCat(this)"><span>ğŸ“¦</span><span data-i18n="other">Other</span></button>
        </div>
      </div>
      <div class="field">
        <label id="lblPriority">Priority</label>
        <div class="urg-row">
          <button class="urg-btn" data-urg="urgent"   onclick="pickUrg(this)" data-i18n="urgent">Urgent</button>
          <button class="urg-btn" data-urg="normal"   onclick="pickUrg(this)" data-i18n="normal">Normal</button>
          <button class="urg-btn" data-urg="sometime" onclick="pickUrg(this)" data-i18n="sometime">Someday</button>
        </div>
      </div>
      <div class="field">
        <label id="lblNote">Note <span style="text-transform:none;letter-spacing:0;font-weight:400;" id="lblNoteOptional">(optional)</span></label>
        <textarea id="fNote" placeholder="Brand, size, quantity, linkâ€¦"></textarea>
      </div>
      <button class="add-btn" id="submitBtn" onclick="addItem()">Add to List</button>
    </div>

    <!-- MY LISTS panel -->
    <div class="sb-panel" id="sbPanelLists">
      <div class="sec-label" id="listBuilderLabel">New list</div>
      <input class="tpl-name" id="tplName" placeholder="List nameâ€¦" maxlength="40">
      <div class="tpl-area" id="tplArea"><div class="tpl-empty" id="tplEmptyMsg">No items yet â€” add below</div></div>
      <div class="ti-adder">
        <input id="tiName" placeholder="Item nameâ€¦" maxlength="80" onkeydown="if(event.key==='Enter')addTplItem()">
        <textarea id="tiNote" placeholder="Note (optional)â€¦" rows="1"></textarea>
        <div class="ti-r2">
          <select id="tiCat">
            <option value="food">ğŸ›’ Food</option><option value="toys">ğŸ§¸ Toys</option>
            <option value="clothes">ğŸ‘• Clothes</option><option value="school">ğŸ’ School</option>
            <option value="house">ğŸ¡ House</option><option value="health">ğŸ’Š Health</option>
            <option value="fun">ğŸ‰ Fun</option><option value="other">ğŸ“¦ Other</option>
          </select>
          <select id="tiUrg">
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
            <option value="sometime">Someday</option>
          </select>
          <button class="ti-add-btn" id="tiAddBtn" onclick="addTplItem()">+ Add</button>
        </div>
      </div>
      <button class="save-list-btn" id="saveListBtn" onclick="saveTemplate()">Save List</button>
      <div class="divider"></div>
      <div class="sec-label" id="savedListsLabel">Saved lists</div>
      <div class="saved-cards" id="savedCards"><div class="no-saved" id="noSavedMsg">No saved lists yet</div></div>
    </div>
  </div><!-- /sidebar -->

  <!-- MAIN -->
  <div class="main" id="mainCol">
    <div id="noFamilyBanner" class="no-family-banner" style="display:none;">
      <div class="nf-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
      <h3 id="nfTitle">You're not in a family yet</h3>
      <p id="nfSubtitle">Create a new family list or join an existing one with an invite code. Everyone in your family will share the same list.</p>
      <button class="btn btn-primary" id="nfSetupBtn" onclick="openFamilyScreen()">Set Up Family</button>
    </div>
    <div id="listSection">
      <div class="filter-row" id="filterRow">
        <button class="f-chip active" data-f="all"     onclick="setFilter(this,'all')" data-i18n="all">All</button>
        <button class="f-chip" data-f="urgent"  onclick="setFilter(this,'urgent')" data-i18n="urgentFilter">ğŸ”´ Urgent</button>
        <button class="f-chip" data-f="food"    onclick="setFilter(this,'food')">ğŸ›’ <span data-i18n="food">Food</span></button>
        <button class="f-chip" data-f="toys"    onclick="setFilter(this,'toys')">ğŸ§¸ <span data-i18n="toys">Toys</span></button>
        <button class="f-chip" data-f="clothes" onclick="setFilter(this,'clothes')">ğŸ‘• <span data-i18n="clothes">Clothes</span></button>
        <button class="f-chip" data-f="school"  onclick="setFilter(this,'school')">ğŸ’ <span data-i18n="school">School</span></button>
        <button class="f-chip" data-f="house"   onclick="setFilter(this,'house')">ğŸ¡ <span data-i18n="house">House</span></button>
        <button class="f-chip" data-f="health"  onclick="setFilter(this,'health')">ğŸ’Š <span data-i18n="health">Health</span></button>
        <button class="f-chip" data-f="fun"     onclick="setFilter(this,'fun')">ğŸ‰ <span data-i18n="fun">Fun</span></button>
        <button class="f-chip" data-f="other"   onclick="setFilter(this,'other')">ğŸ“¦ <span data-i18n="other">Other</span></button>
      </div>
      <div class="list-filter-row" id="listFilterRow" style="display:none;">
        <span class="lf-label">Lists:</span>
      </div>
      <div class="toolbar">
        <span class="result-info" id="resultInfo"></span>
        <div style="display:flex;gap:6px;align-items:center;">
          <button class="clear-btn" id="refreshBtn" onclick="manualRefresh()" title="Refresh list">â†»</button>
          <button class="clear-btn" id="clearDoneBtn" onclick="confirmClearDone()">Clear done</button>
        </div>
      </div>
      <div class="items-list" id="itemsList"></div>
    </div>
  </div>

</div><!-- /app-shell -->

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-nav">
  <button class="mn-btn active" id="mnList" onclick="mobileShow('list')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
      <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/>
      <line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/>
      <line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
    </svg>
    <span data-i18n="list">List</span>
  </button>
  <button class="mn-btn" id="mnAdd" onclick="mobileShow('add')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
      <circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12" y2="16"/>
      <line x1="8" y1="12" x2="16" y2="12"/>
    </svg>
    <span data-i18n="addItem">Add Item</span>
  </button>
  <button class="mn-btn" id="mnLists" onclick="mobileShow('lists')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
      <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
    </svg>
    <span data-i18n="myLists">My Lists</span>
  </button>
</nav>

<script>
/* â•â•â• API â•â•â• */
const SRV = (location.hostname==='localhost'||location.hostname==='127.0.0.1')
  ? 'http://localhost:8080/api'
  : (location.origin + '/api');

/* â•â•â• LANGUAGE / i18n â•â•â• */
const TRANSLATIONS = {
  en: {
    // auth
    appName: 'Family List',
    authSubtitle: 'Your shared family shopping & to-do list. Sign up or log in to get started.',
    login: 'Log In', signup: 'Sign Up',
    lblLoginEmail: 'Email', lblLoginPwd: 'Password',
    lblSignupName: 'Your Name', lblSignupEmail: 'Email',
    lblSignupPwd: 'Password', lblSignupPwdHint: '(min 6 characters)',
    loginBtn: 'Log In', signupBtn: 'Create Account',
    phLoginEmail: 'you@example.com', phLoginPwd: 'Your password',
    phSignupName: 'e.g. Sarah', phSignupEmail: 'you@example.com', phSignupPwd: 'Create a password',
    // family screen
    famTitle: 'Join or Create a Family',
    famSubtitle: 'Create a new family list and share the invite code, or join an existing one.',
    createFamily: 'Create Family', joinFamily: 'Join Family',
    lblFamName: 'Family Name', hintFamName: 'This is the name your family members will see.',
    phFamName: 'e.g. The Smiths',
    lblJoinName: 'Family Name', hintJoinName: "The name of the family you're joining.",
    phJoinName: 'e.g. The Smiths',
    lblJoinCode: 'Invite Code', hintJoinCode: 'Ask your family member for their invite code.',
    phJoinCode: 'e.g. BLUE-7492',
    createFamBtn: 'Create Family', joinFamBtn: 'Join Family',
    famSuccessTitle: 'Family Created!',
    famSuccessMsg: 'Share this invite code with your family members so they can join:',
    famSuccessHint: 'They go to "Join Family" and enter this code.',
    famSuccessBtn: 'Go to My List â†’',
    // add item
    addItem: 'Add Item', myLists: 'My Lists',
    lblAddedBy: 'Added by', lblItemName: 'Item name', lblCategory: 'Category',
    lblPriority: 'Priority', lblNote: 'Note', lblNoteOptional: '(optional)',
    phItemName: 'e.g. Milk, Batteries, Shampooâ€¦',
    phNote: 'Brand, size, quantity, linkâ€¦',
    submitBtn: 'Add to List',
    // categories
    food: 'Food', toys: 'Toys', clothes: 'Clothes', school: 'School',
    house: 'House', health: 'Health', fun: 'Fun', other: 'Other',
    // urgency
    urgent: 'Urgent', normal: 'Normal', sometime: 'Someday',
    // lists panel
    listBuilderNew: 'New list', saveListBtn: 'Save List', updateListBtn: 'Update List',
    phListName: 'List nameâ€¦', phTiName: 'Item nameâ€¦', phTiNote: 'Note (optional)â€¦',
    savedListsLabel: 'Saved lists', noSavedMsg: 'No saved lists yet',
    tplEmptyMsg: 'No items yet â€” add below', tiAddBtn: '+ Add',
    // filters
    all: 'All', urgentFilter: 'ğŸ”´ Urgent',
    list: 'List',
    // toolbar
    clearDone: 'Clear done',
    // no family banner
    nfTitle: "You're not in a family yet",
    nfSubtitle: 'Create a new family list or join an existing one with an invite code. Everyone in your family will share the same list.',
    nfSetupBtn: 'Set Up Family',
    // account menu
    inviteCode: 'Invite code:',
    familySettings: 'Family Settings', deleteFamily: 'ğŸ—‘ Delete Family', leaveFamily: 'ğŸ‘‹ Leave Family',
    joinCreateFamily: 'Join / Create Family', logout: 'Log Out',
    deleteAllItems: 'ğŸ—‘ Delete All Items', notInFamily: 'Not in a family yet.',
    youLabel: 'you', removeBtn: 'Remove',
    // confirm modal
    cancelBtn: 'Cancel', deleteBtn: 'Delete',
    // kicked overlay
    kickedTitle: "You've been removed",
    kickedDefault: 'You are no longer in this family.',
    kickedOk: 'OK',
    // toasts & errors
    toastRefreshed: 'List refreshed', toastItemAdded: 'Added',
    toastItemUpdated: 'Item updated', toastItemRemoved: 'Item removed',
    toastFamilyDeleted: 'Family deleted', toastLeftFamily: 'Left family',
    toastListDeleted: 'List deleted', toastListSaved: 'List saved',
    toastNoCompleted: 'No completed items',
    errFillAll: 'Fill in all fields', errEmailPwd: 'Enter email and password',
    errFamName: 'Enter a family name', errJoinName: 'Enter the family name',
    errJoinCode: 'Enter the invite code', errItemName: 'Enter an item name',
    errPickCat: 'Pick a category', errListName: 'Give your list a name',
    errAddOneItem: 'Add at least one item', errNoItems: 'No items to delete',
    errJoinFirst: 'Join a family first',
    // render
    byLabel: 'by',
    nothingNeeded: 'Nothing needed right now', nothingCategory: 'Nothing in this category',
    addItemHint: 'Add an item using the form',
    resultItem: 'item', resultItems: 'items',
    allDone: 'All done!', itemsNeeded: 'items needed', itemNeeded: 'item needed',
    editSave: 'Save', editCancel: 'Cancel',
    addAll: 'Add All', editList: 'Edit', deleteList: 'Delete',
    scItems: 'items', scItem: 'item',
    listEditingPrefix: 'Editing: ',
    editListToast: 'Edit then click Update List',
    addedFrom: 'Added',
    fromList: 'from',
    // misc
    loading: 'Loadingâ€¦', loggingIn: 'Logging inâ€¦', creatingAccount: 'Creating accountâ€¦',
    creating: 'Creatingâ€¦', joining: 'Joiningâ€¦', adding: 'Addingâ€¦', saving: 'Savingâ€¦',
  },
  he: {
    // auth
    appName: '×¨×©×™××ª ×”××©×¤×—×”',
    authSubtitle: '×¨×©×™××ª ×”×§× ×™×•×ª ×•×”××©×™××•×ª ×”××©×•×ª×¤×ª ×©×œ×›×. ×”×™×¨×©××• ××• ×”×ª×—×‘×¨×• ×œ×”×ª×—×œ×”.',
    login: '×”×ª×—×‘×¨×•×ª', signup: '×”×¨×©××”',
    lblLoginEmail: '××™××™×™×œ', lblLoginPwd: '×¡×™×¡××”',
    lblSignupName: '×”×©× ×©×œ×š', lblSignupEmail: '××™××™×™×œ',
    lblSignupPwd: '×¡×™×¡××”', lblSignupPwdHint: '(×œ×¤×—×•×ª 6 ×ª×•×•×™×)',
    loginBtn: '×”×ª×—×‘×¨', signupBtn: '×¦×•×¨ ×—×©×‘×•×Ÿ',
    phLoginEmail: 'you@example.com', phLoginPwd: '×”×¡×™×¡××” ×©×œ×š',
    phSignupName: '×œ×“×•×’××”: ×©×¨×”', phSignupEmail: 'you@example.com', phSignupPwd: '×¦×•×¨ ×¡×™×¡××”',
    // family screen
    famTitle: '×”×¦×˜×¨×£ ××• ×¦×•×¨ ××©×¤×—×”',
    famSubtitle: '×¦×•×¨ ×¨×©×™××ª ××©×¤×—×” ×—×“×©×” ×•×©×ª×£ ××ª ×§×•×“ ×”×”×–×× ×”, ××• ×”×¦×˜×¨×£ ×œ×§×™×™××ª.',
    createFamily: '×¦×•×¨ ××©×¤×—×”', joinFamily: '×”×¦×˜×¨×£ ×œ××©×¤×—×”',
    lblFamName: '×©× ×”××©×¤×—×”', hintFamName: '×–×” ×”×©× ×©×—×‘×¨×™ ×”××©×¤×—×” ×©×œ×š ×™×¨××•.',
    phFamName: '×œ×“×•×’××”: ××©×¤×—×ª ×›×”×Ÿ',
    lblJoinName: '×©× ×”××©×¤×—×”', hintJoinName: '×©× ×”××©×¤×—×” ×©××œ×™×” ××ª×” ××¦×˜×¨×£.',
    phJoinName: '×œ×“×•×’××”: ××©×¤×—×ª ×›×”×Ÿ',
    lblJoinCode: '×§×•×“ ×”×–×× ×”', hintJoinCode: '×‘×§×© ××—×‘×¨ ×”××©×¤×—×” ××ª ×§×•×“ ×”×”×–×× ×”.',
    phJoinCode: '×œ×“×•×’××”: BLUE-7492',
    createFamBtn: '×¦×•×¨ ××©×¤×—×”', joinFamBtn: '×”×¦×˜×¨×£ ×œ××©×¤×—×”',
    famSuccessTitle: '×”××©×¤×—×” × ×•×¦×¨×”!',
    famSuccessMsg: '×©×ª×£ ××ª ×§×•×“ ×”×”×–×× ×” ×”×–×” ×¢× ×—×‘×¨×™ ×”××©×¤×—×” ×©×œ×š ×›×“×™ ×©×™×•×›×œ×• ×œ×”×¦×˜×¨×£:',
    famSuccessHint: '×”× ×™×œ×›×• ×œ"×”×¦×˜×¨×£ ×œ××©×¤×—×”" ×•×™×–×™× ×• ××ª ×”×§×•×“ ×”×–×”.',
    famSuccessBtn: 'â† ×œ×¨×©×™××” ×©×œ×™',
    // add item
    addItem: '×”×•×¡×£ ×¤×¨×™×˜', myLists: '×”×¨×©×™××•×ª ×©×œ×™',
    lblAddedBy: '× ×•×¡×£ ×¢×œ ×™×“×™', lblItemName: '×©× ×”×¤×¨×™×˜', lblCategory: '×§×˜×’×•×¨×™×”',
    lblPriority: '×¢×“×™×¤×•×ª', lblNote: '×”×¢×¨×”', lblNoteOptional: '(×¨×©×•×ª)',
    phItemName: '×œ×“×•×’××”: ×—×œ×‘, ×¡×•×œ×œ×•×ª, ×©××¤×•â€¦',
    phNote: '××•×ª×’, ×’×•×“×œ, ×›××•×ª, ×§×™×©×•×¨â€¦',
    submitBtn: '×”×•×¡×£ ×œ×¨×©×™××”',
    // categories
    food: '××–×•×Ÿ', toys: '×¦×¢×¦×•×¢×™×', clothes: '×‘×’×“×™×', school: '×‘×™×ª ×¡×¤×¨',
    house: '×‘×™×ª', health: '×‘×¨×™××•×ª', fun: '×›×™×£', other: '××—×¨',
    // urgency
    urgent: '×“×—×•×£', normal: '×¨×’×™×œ', sometime: '×™×•× ××—×“',
    // lists panel
    listBuilderNew: '×¨×©×™××” ×—×“×©×”', saveListBtn: '×©××•×¨ ×¨×©×™××”', updateListBtn: '×¢×“×›×Ÿ ×¨×©×™××”',
    phListName: '×©× ×”×¨×©×™××”â€¦', phTiName: '×©× ×”×¤×¨×™×˜â€¦', phTiNote: '×”×¢×¨×” (×¨×©×•×ª)â€¦',
    savedListsLabel: '×¨×©×™××•×ª ×©××•×¨×•×ª', noSavedMsg: '××™×Ÿ ×¨×©×™××•×ª ×©××•×¨×•×ª ×¢×“×™×™×Ÿ',
    tplEmptyMsg: '××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ â€” ×”×•×¡×£ ×œ××˜×”', tiAddBtn: '+ ×”×•×¡×£',
    // filters
    all: '×”×›×œ', urgentFilter: 'ğŸ”´ ×“×—×•×£',
    list: '×¨×©×™××”',
    // toolbar
    clearDone: '××—×§ ×©×”×¡×ª×™×™×',
    // no family banner
    nfTitle: '×¢×“×™×™×Ÿ ×œ× ×‘××©×¤×—×”',
    nfSubtitle: '×¦×•×¨ ×¨×©×™××ª ××©×¤×—×” ×—×“×©×” ××• ×”×¦×˜×¨×£ ×œ×§×™×™××ª ×¢× ×§×•×“ ×”×–×× ×”. ×›×œ ×—×‘×¨×™ ×”××©×¤×—×” ×©×œ×š ×™×©×ª×¤×• ××ª ××•×ª×” ×”×¨×©×™××”.',
    nfSetupBtn: '×”×’×“×¨ ××©×¤×—×”',
    // account menu
    inviteCode: '×§×•×“ ×”×–×× ×”:',
    familySettings: '×”×’×“×¨×•×ª ××©×¤×—×”', deleteFamily: 'ğŸ—‘ ××—×§ ××©×¤×—×”', leaveFamily: 'ğŸ‘‹ ×¢×–×•×‘ ××©×¤×—×”',
    joinCreateFamily: '×”×¦×˜×¨×£ / ×¦×•×¨ ××©×¤×—×”', logout: '×”×ª× ×ª×§',
    deleteAllItems: 'ğŸ—‘ ××—×§ ××ª ×›×œ ×”×¤×¨×™×˜×™×', notInFamily: '×¢×“×™×™×Ÿ ×œ× ×‘××©×¤×—×”.',
    youLabel: '××ª/×”', removeBtn: '×”×¡×¨',
    // confirm modal
    cancelBtn: '×‘×™×˜×•×œ', deleteBtn: '××—×§',
    // kicked overlay
    kickedTitle: '×”×•×¡×¨×ª ××”××©×¤×—×”',
    kickedDefault: '××™× ×š ×¢×•×“ ×—×œ×§ ×××©×¤×—×” ×–×•.',
    kickedOk: '××™×©×•×¨',
    // toasts & errors
    toastRefreshed: '×”×¨×©×™××” ×¢×•×“×›× ×”', toastItemAdded: '× ×•×¡×£',
    toastItemUpdated: '×”×¤×¨×™×˜ ×¢×•×“×›×Ÿ', toastItemRemoved: '×”×¤×¨×™×˜ ×”×•×¡×¨',
    toastFamilyDeleted: '×”××©×¤×—×” × ××—×§×”', toastLeftFamily: '×¢×–×‘×ª ××ª ×”××©×¤×—×”',
    toastListDeleted: '×”×¨×©×™××” × ××—×§×”', toastListSaved: '×”×¨×©×™××” × ×©××¨×”',
    toastNoCompleted: '××™×Ÿ ×¤×¨×™×˜×™× ×©×”×¡×ª×™×™××•',
    errFillAll: '××œ× ××ª ×›×œ ×”×©×“×•×ª', errEmailPwd: '×”×–×Ÿ ××™××™×™×œ ×•×¡×™×¡××”',
    errFamName: '×”×–×Ÿ ×©× ××©×¤×—×”', errJoinName: '×”×–×Ÿ ××ª ×©× ×”××©×¤×—×”',
    errJoinCode: '×”×–×Ÿ ××ª ×§×•×“ ×”×”×–×× ×”', errItemName: '×”×–×Ÿ ×©× ×¤×¨×™×˜',
    errPickCat: '×‘×—×¨ ×§×˜×’×•×¨×™×”', errListName: '×ª×Ÿ ×©× ×œ×¨×©×™××” ×©×œ×š',
    errAddOneItem: '×”×•×¡×£ ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“', errNoItems: '××™×Ÿ ×¤×¨×™×˜×™× ×œ××—×™×§×”',
    errJoinFirst: '×”×¦×˜×¨×£ ×œ××©×¤×—×” ×ª×—×™×œ×”',
    // render
    byLabel: '×¢"×™',
    nothingNeeded: '×œ× ×¦×¨×™×š ×›×œ×•× ×›×¨×’×¢', nothingCategory: '××™×Ÿ ×›×œ×•× ×‘×§×˜×’×•×¨×™×” ×–×•',
    addItemHint: '×”×•×¡×£ ×¤×¨×™×˜ ×‘×××¦×¢×•×ª ×”×˜×•×¤×¡',
    resultItem: '×¤×¨×™×˜', resultItems: '×¤×¨×™×˜×™×',
    allDone: '×”×›×œ ×”×•×©×œ×!', itemsNeeded: '×¤×¨×™×˜×™× × ×“×¨×©×™×', itemNeeded: '×¤×¨×™×˜ × ×“×¨×©',
    editSave: '×©××•×¨', editCancel: '×‘×™×˜×•×œ',
    addAll: '×”×•×¡×£ ×”×›×œ', editList: '×¢×¨×•×š', deleteList: '××—×§',
    scItems: '×¤×¨×™×˜×™×', scItem: '×¤×¨×™×˜',
    listEditingPrefix: '×¢×¨×™×›×”: ',
    editListToast: '×¢×¨×•×š ×•××– ×œ×—×¥ ×¢×“×›×Ÿ ×¨×©×™××”',
    addedFrom: '× ×•×¡×¤×•',
    fromList: '×',
    // misc
    loading: '×˜×•×¢×Ÿâ€¦', loggingIn: '××ª×—×‘×¨â€¦', creatingAccount: '×™×•×¦×¨ ×—×©×‘×•×Ÿâ€¦',
    creating: '×™×•×¦×¨â€¦', joining: '××¦×˜×¨×£â€¦', adding: '××•×¡×™×£â€¦', saving: '×©×•××¨â€¦',
  }
};

let LANG = 'en';
function getLang(){ return LANG; }
function t(key){ return TRANSLATIONS[LANG][key] || TRANSLATIONS['en'][key] || key; }

function setLang(lang){
  LANG = lang;
  localStorage.setItem('fl_lang', lang);
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
  applyTranslations();
}

function applyTranslations(){
  const L = LANG;
  // lang toggle buttons
  const authEN = document.getElementById('authLangEN');
  const authHE = document.getElementById('authLangHE');
  const hEN = document.getElementById('hLangEN');
  const hHE = document.getElementById('hLangHE');
  if(authEN){ authEN.classList.toggle('active', L==='en'); }
  if(authHE){ authHE.classList.toggle('active', L==='he'); }
  if(hEN){ hEN.classList.toggle('active', L==='en'); }
  if(hHE){ hHE.classList.toggle('active', L==='he'); }

  // Helper to safely set textContent
  const tx = (id, key) => { const el=document.getElementById(id); if(el) el.textContent=t(key); };
  const ph = (id, key) => { const el=document.getElementById(id); if(el) el.placeholder=t(key); };
  const tv = (id, key) => { const el=document.getElementById(id); if(el) el.value=t(key); };

  // Auth screen
  tx('authTitle','appName');
  tx('authSubtitle','authSubtitle');
  tx('authTabLogin','login'); tx('authTabSignup','signup');
  tx('lblLoginEmail','lblLoginEmail'); tx('lblLoginPwd','lblLoginPwd');
  tx('lblSignupName','lblSignupName'); tx('lblSignupEmail','lblSignupEmail');
  tx('lblSignupPwd','lblSignupPwd'); tx('lblSignupPwdHint','lblSignupPwdHint');
  // keep "Password " prefix on label
  const pwdLbl = document.getElementById('lblSignupPwd');
  if(pwdLbl && pwdLbl.childNodes[0]) pwdLbl.childNodes[0].textContent = t('lblSignupPwd')+' ';
  tx('loginBtn', 'loginBtn'); tx('signupBtn','signupBtn');
  ph('loginEmail','phLoginEmail'); ph('loginPwd','phLoginPwd');
  ph('signupName','phSignupName'); ph('signupEmail','phSignupEmail'); ph('signupPwd','phSignupPwd');

  // Family screen
  tx('famTitle','famTitle'); tx('famSubtitle','famSubtitle');
  tx('famTabCreate','createFamily'); tx('famTabJoin','joinFamily');
  tx('lblFamName','lblFamName'); tx('hintFamName','hintFamName');
  ph('famName','phFamName');
  tx('lblJoinName','lblJoinName'); tx('hintJoinName','hintJoinName');
  ph('joinName','phJoinName');
  tx('lblJoinCode','lblJoinCode'); tx('hintJoinCode','hintJoinCode');
  ph('joinCode','phJoinCode');
  tx('createFamBtn','createFamBtn'); tx('joinFamBtn','joinFamBtn');
  tx('famSuccessTitle','famSuccessTitle'); tx('famSuccessMsg','famSuccessMsg');
  tx('famSuccessHint','famSuccessHint'); tx('famSuccessBtn','famSuccessBtn');

  // Add item panel
  tx('lblAddedBy','lblAddedBy'); tx('lblItemName','lblItemName'); tx('lblCategory','lblCategory');
  tx('lblPriority','lblPriority'); tx('lblNote','lblNote'); tx('lblNoteOptional','lblNoteOptional');
  ph('fName','phItemName'); ph('fNote','phNote');
  tx('submitBtn','submitBtn');

  // Sidebar tabs
  tx('sbTabAdd','addItem'); tx('sbTabLists','myLists');

  // Lists panel
  ph('tplName','phListName'); ph('tiName','phTiName'); ph('tiNote','phTiNote');
  tx('tiAddBtn','tiAddBtn');
  tx('savedListsLabel','savedListsLabel');
  tx('saveListBtn','saveListBtn');
  // Re-render tpl area and saved cards so their text is in new language
  if(typeof renderTplItems === 'function') renderTplItems();
  if(typeof renderSavedCards === 'function') renderSavedCards();

  // Toolbar
  tx('clearDoneBtn','clearDone');

  // No family banner
  tx('nfTitle','nfTitle'); tx('nfSubtitle','nfSubtitle'); tx('nfSetupBtn','nfSetupBtn');

  // Account menu
  const amInvLabel = document.getElementById('amInviteLabel');
  if(amInvLabel) amInvLabel.textContent = t('inviteCode');
  tx('amLogoutBtn','logout');
  tx('amInviteLabel','inviteCode');
  const deleteAllBtn = document.querySelector('.am-btn.danger[onclick="adminDeleteAllItems()"]');
  if(deleteAllBtn) deleteAllBtn.textContent = t('deleteAllItems');
  tx('amNoFam','notInFamily');

  tx('kickedOkBtn','kickedOk');

  // Confirm modal
  const cancelBtn = document.querySelector('#confirmModal .btn-ghost');
  if(cancelBtn) cancelBtn.textContent = t('cancelBtn');

  // Kicked overlay
  tx('kickedTitle','kickedTitle');

  // Mobile nav data-i18n spans
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if(key && TRANSLATIONS[LANG][key]) el.textContent = TRANSLATIONS[LANG][key];
  });

  // Category labels in selects
  const catMap = {food:'food',toys:'toys',clothes:'clothes',school:'school',house:'house',health:'health',fun:'fun',other:'other'};
  ['tiCat','ei-cat'].forEach(selectId => {
    const sel = document.getElementById(selectId);
    if(!sel) return;
    Array.from(sel.options).forEach(opt => {
      const catKey = opt.value;
      if(catMap[catKey]) opt.textContent = (CE[catKey]||'') + ' ' + t(catKey);
    });
  });
  // Urgency selects
  ['tiUrg','ei-urg'].forEach(selectId => {
    const sel = document.getElementById(selectId);
    if(!sel) return;
    Array.from(sel.options).forEach(opt => {
      const urgKey = opt.value;
      opt.textContent = t(urgKey);
    });
  });

  // Refresh the main render so item cards use translated strings
  // Only re-render if we actually have items or are logged in (avoid wiping state at init)
  if(typeof render === 'function' && items && items.length >= 0 && SESSION) render();
  if(typeof updateHeader === 'function' && SESSION) updateHeader();
}

// Current user session (persisted to localStorage)
let SESSION = null; // { userId, name, email, familyId }
let FAMILY = null;  // { id, name, code }

function getSession(){
  try { return JSON.parse(localStorage.getItem('fl_session')||'null'); } catch { return null; }
}
function saveSession(s){ localStorage.setItem('fl_session', JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem('fl_session'); localStorage.removeItem('fl_family'); }
function getStoredFamily(){ try { return JSON.parse(localStorage.getItem('fl_family')||'null'); } catch { return null; } }
function saveFamily(f){ if(f) localStorage.setItem('fl_family', JSON.stringify(f)); else localStorage.removeItem('fl_family'); }

function authHeaders(){
  return { 'Content-Type':'application/json', 'x-user-id': SESSION?.userId||'' };
}

async function apiFetch(path, opts={}){
  const r = await fetch(SRV + path, {
    ...opts,
    headers: { ...(opts.headers||{}), ...authHeaders() }
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || 'Request failed');
  return data;
}

/* â•â•â• AUTH â•â•â• */
function authTab(tab){
  document.getElementById('authTabLogin').classList.toggle('active', tab==='login');
  document.getElementById('authTabSignup').classList.toggle('active', tab==='signup');
  document.getElementById('authPanelLogin').style.display = tab==='login'?'':'none';
  document.getElementById('authPanelSignup').style.display = tab==='signup'?'':'none';
}

async function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const pwd   = document.getElementById('loginPwd').value;
  const err   = document.getElementById('loginErr');
  const btn   = document.getElementById('loginBtn');
  err.classList.remove('show');
  if (!email||!pwd){ showErr(err,t('errEmailPwd')); return; }
  btn.disabled=true; btn.textContent=t('loggingIn');
  try {
    const { user, family } = await apiFetch('/auth/login', {
      method:'POST', body: JSON.stringify({email,password:pwd})
    });
    SESSION = { userId: user.id, name: user.name, email: user.email, familyId: user.family_id };
    FAMILY = family;
    saveSession(SESSION);
    onLoggedIn();
  } catch(e) {
    showErr(err, e.message);
  } finally {
    btn.disabled=false; btn.textContent=t('loginBtn');
  }
}

async function doSignup(){
  const name  = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const pwd   = document.getElementById('signupPwd').value;
  const err   = document.getElementById('signupErr');
  const btn   = document.getElementById('signupBtn');
  err.classList.remove('show');
  if (!name||!email||!pwd){ showErr(err,t('errFillAll')); return; }
  btn.disabled=true; btn.textContent=t('creatingAccount');
  try {
    await apiFetch('/auth/signup', { method:'POST', body: JSON.stringify({name,email,password:pwd}) });
    // auto login after signup
    const { user, family } = await apiFetch('/auth/login', {
      method:'POST', body: JSON.stringify({email,password:pwd})
    });
    SESSION = { userId: user.id, name: user.name, email: user.email, familyId: user.family_id };
    FAMILY = family;
    saveSession(SESSION);
    onLoggedIn();
  } catch(e) {
    showErr(err, e.message);
  } finally {
    btn.disabled=false; btn.textContent=t('signupBtn');
  }
}

function doLogout(){
  clearSession();
  SESSION = null; FAMILY = null;
  closeAccountMenu();
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('familyScreen').classList.add('hidden');
}

function showErr(el, msg){ el.textContent=msg; el.classList.add('show'); }

function onLoggedIn(){
  document.getElementById('authScreen').classList.add('hidden');
  updateAccountMenu();
  if (!SESSION.familyId) {
    openFamilyScreen();
  } else {
    document.getElementById('familyScreen').classList.add('hidden');
    document.getElementById('fWho').value = SESSION.name;
    document.getElementById('hUser').textContent = SESSION.name;
    updateNoFamilyBanner();
    load();
    startSSE();
    // On mobile, default to showing the list view with nav visible
    if(isMob()) mobileShow('list');
  }
}

/* â•â•â• FAMILY â•â•â• */
function famTab(tab){
  document.getElementById('famTabCreate').classList.toggle('active', tab==='create');
  document.getElementById('famTabJoin').classList.toggle('active', tab==='join');
  document.getElementById('famPanelCreate').classList.toggle('active', tab==='create');
  document.getElementById('famPanelJoin').classList.toggle('active', tab==='join');
}

function openFamilyScreen(){
  closeAccountMenu();
  document.getElementById('familyScreen').classList.remove('hidden');
}

async function leaveFamilyThenOpen(){
  if (SESSION?.familyId) {
    const isOwner = FAMILY?.ownerId === SESSION.userId;
    if (isOwner) {
      const ok = await confirm2('Delete family?', 'This will delete the family and remove all members. This cannot be undone.', 'ğŸ—‘');
      if (!ok) return;
      try {
        await apiFetch('/family/delete', { method: 'POST' });
      } catch(e) { toast(e.message); return; }
      toast(t('toastFamilyDeleted'));
    } else {
      const ok = await confirm2('Leave family?', 'You will need an invite code to rejoin.', 'ğŸ‘‹', 'Leave');
      if (!ok) return;
      try {
        await apiFetch('/family/leave', { method: 'POST' });
      } catch(e) { toast(e.message); return; }
      toast(t('toastLeftFamily'));
    }
    SESSION.familyId = null;
    FAMILY = null;
    saveSession(SESSION);
    if (sse) { sse.close(); sse = null; }
    updateAccountMenu();
    updateNoFamilyBanner();
    items = []; render(); updateHeader();
  }
  openFamilyScreen();
}

function closeFamilyScreen(){
  document.getElementById('familyScreen').classList.add('hidden');
  document.getElementById('famSuccess').style.display = 'none';
  document.getElementById('famMain').style.display = '';
}

async function doCreateFamily(){
  const name = document.getElementById('famName').value.trim();
  const err  = document.getElementById('createErr');
  const btn  = document.getElementById('createFamBtn');
  err.classList.remove('show');
  if (!name){ showErr(err,t('errFamName')); return; }
  btn.disabled=true; btn.textContent=t('creating');
  try {
    const { family } = await apiFetch('/family/create', { method:'POST', body: JSON.stringify({name}) });
    FAMILY = family;
    SESSION.familyId = family.id;
    saveSession(SESSION);
    // Show the big code screen
    document.getElementById('famMain').style.display = 'none';
    document.getElementById('famSuccessCode').textContent = family.code;
    document.getElementById('famSuccess').style.display = '';
    updateAccountMenu();
    updateNoFamilyBanner();
    load();
  } catch(e) {
    showErr(err, e.message);
  } finally {
    btn.disabled=false; btn.textContent=t('createFamBtn');
  }
}

async function doJoinFamily(){
  const name = document.getElementById('joinName').value.trim();
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  const err  = document.getElementById('joinErr');
  const btn  = document.getElementById('joinFamBtn');
  err.classList.remove('show');
  if (!name){ showErr(err,t('errJoinName')); return; }
  if (!code){ showErr(err,t('errJoinCode')); return; }
  btn.disabled=true; btn.textContent=t('joining');
  try {
    const { family } = await apiFetch('/family/join', { method:'POST', body: JSON.stringify({code, name}) });
    FAMILY = family;
    SESSION.familyId = family.id;
    saveSession(SESSION);
    onFamilyJoined();
    toast('Joined "'+family.name+'" ğŸ‰');
  } catch(e) {
    showErr(err, e.message);
  } finally {
    btn.disabled=false; btn.textContent=t('joinFamBtn');
  }
}

function onFamilyJoined(){
  document.getElementById('familyScreen').classList.add('hidden');
  document.getElementById('fWho').value = SESSION.name;
  document.getElementById('hUser').textContent = SESSION.name;
  updateAccountMenu();
  updateNoFamilyBanner();
  load();
  loadLists();
  startSSE();
  if(isMob()) mobileShow('list');
}

function updateNoFamilyBanner(){
  const hasFam = !!SESSION?.familyId;
  document.getElementById('noFamilyBanner').style.display = hasFam ? 'none' : '';
  document.getElementById('listSection').style.display = hasFam ? '' : 'none';
}

/* â•â•â• ACCOUNT MENU â•â•â• */
function toggleAccountMenu(){
  const menu = document.getElementById('accountMenu');
  const isOpen = menu.classList.contains('open');
  if (!isOpen) updateAccountMenu();
  menu.classList.toggle('open');
}
function closeAccountMenu(){
  document.getElementById('accountMenu').classList.remove('open');
}
document.addEventListener('click', e => {
  const menu = document.getElementById('accountMenu');
  const btn  = document.querySelector('.h-user');
  if (!menu.contains(e.target) && !btn.contains(e.target)) closeAccountMenu();
});
async function updateAccountMenu(){
  if (!SESSION) return;
  document.getElementById('amName').textContent  = SESSION.name;
  document.getElementById('amEmail').textContent = SESSION.email;
  // Always fetch fresh family info so ownerId is correct
  if (SESSION.familyId) {
    try {
      const { user, family } = await apiFetch('/auth/me');
      FAMILY = family;
    } catch {}
  }
  if (FAMILY) {
    document.getElementById('amFamBlock').style.display = '';
    document.getElementById('amNoFam').style.display = 'none';
    document.getElementById('amFamName').textContent = FAMILY.name;
    document.getElementById('amFamCode').textContent = FAMILY.code;
    const isOwner = FAMILY.ownerId === SESSION.userId;
    document.getElementById('amFamBtn').textContent = isOwner ? t('deleteFamily') : t('leaveFamily');
    document.getElementById('amFamBtn').classList.toggle('danger', isOwner);
    if (isOwner) loadMembers();
    else document.getElementById('amMembersBlock').style.display = 'none';
  } else {
    document.getElementById('amFamBlock').style.display = 'none';
    document.getElementById('amNoFam').style.display = '';
    document.getElementById('amFamBtn').textContent = t('joinCreateFamily');
    document.getElementById('amFamBtn').classList.remove('danger');
  }
  document.getElementById('hUser').textContent = SESSION.name;
  document.getElementById('hSub').textContent  = FAMILY ? FAMILY.name : 'No family yet';
}

async function loadMembers(){
  try {
    const { members, ownerId } = await apiFetch('/family/members');
    const el = document.getElementById('amMembersList');
    el.innerHTML = members.map(m => `
      <div class="am-member">
        <span class="am-member-name">${esc(m.name)}</span>
        ${m.id === SESSION.userId ? `<span class="am-member-you">${t('youLabel')}</span>` : ''}
        ${m.id !== SESSION.userId ? `<button class="am-member-kick" onclick="kickMember('${m.id}','${esc(m.name)}')">${t('removeBtn')}</button>` : ''}
      </div>`).join('');
    document.getElementById('amMembersBlock').style.display = '';
  } catch(e) { console.warn(e); }
}

async function kickMember(memberId, memberName){
  const ok = await confirm2('Remove member?', `Remove ${memberName} from the family?`, 'ğŸ‘¤', 'Remove');
  if (!ok) return;
  try {
    await apiFetch('/family/kick/'+memberId, { method:'POST' });
    toast(memberName + ' ' + t('removeBtn'));
    loadMembers();
  } catch(e) { toast(e.message); }
}

/* â•â•â• CONFIRM â•â•â• */
let _cr=null;
function confirm2(title, body, icon, confirmLabel){
  icon = icon || 'ğŸ—‘';
  confirmLabel = confirmLabel || 'Delete';
  return new Promise(res => {
    if(_cr) _cr(false); _cr = res;
    document.getElementById('mIcon').textContent = icon;
    document.getElementById('mTitle').textContent = title;
    document.getElementById('mBody').textContent = body || title;
    document.getElementById('mConfirmBtn').textContent = confirmLabel;
    document.getElementById('confirmModal').classList.remove('hidden');
    const btn = document.getElementById('mConfirmBtn');
    const nb = btn.cloneNode(true); btn.parentNode.replaceChild(nb, btn);
    nb.onclick = () => { document.getElementById('confirmModal').classList.add('hidden'); const r=_cr; _cr=null; if(r) r(true); };
  });
}
function closeConfirm(){document.getElementById('confirmModal').classList.add('hidden');const r=_cr;_cr=null;if(r)r(false);}

/* â•â•â• SIDEBAR TABS â•â•â• */
function sbTab(tab){
  document.getElementById('sbPanelAdd').classList.toggle('active',tab==='add');
  document.getElementById('sbPanelLists').classList.toggle('active',tab==='lists');
  document.getElementById('sbTabAdd').classList.toggle('active',tab==='add');
  document.getElementById('sbTabLists').classList.toggle('active',tab==='lists');
  if(tab==='lists'){ loadLists(); }
}

/* â•â•â• MOBILE NAV â•â•â• */
function isMob(){return window.matchMedia('(max-width:700px)').matches;}
function mobileShow(view){
  if(!isMob())return;
  document.body.classList.remove('show-add','show-lists');
  document.querySelectorAll('.mn-btn').forEach(b=>b.classList.remove('active'));
  if(view==='add'){document.body.classList.add('show-add');document.getElementById('mnAdd').classList.add('active');sbTab('add');}
  else if(view==='lists'){document.body.classList.add('show-lists');document.getElementById('mnLists').classList.add('active');sbTab('lists');}
  else{document.getElementById('mnList').classList.add('active');}
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â•â•â• STATE â•â•â• */
let items=[],selCat=null,selUrg='normal',activeF='all',activeListF=null,editId=null;
const CE={food:'ğŸ›’',toys:'ğŸ§¸',clothes:'ğŸ‘•',school:'ğŸ’',house:'ğŸ¡',health:'ğŸ’Š',fun:'ğŸ‰',other:'ğŸ“¦'};
function UL(u){ return t(u)||u; }
const UC={urgent:'#dc2626',normal:'#16a34a',sometime:'#94a3b8'};
const CATS=['food','toys','clothes','school','house','health','fun','other'];
const URGS=['urgent','normal','sometime'];

document.querySelector('[data-urg="normal"]').classList.add('su-normal');

function pickCat(btn){document.querySelectorAll('#catGrid .cat-btn').forEach(b=>{b.className='cat-btn';});selCat=btn.dataset.cat;btn.classList.add('sc-'+selCat);}
function pickUrg(btn){document.querySelectorAll('.urg-btn').forEach(b=>{b.className='urg-btn';});selUrg=btn.dataset.urg;btn.classList.add('su-'+selUrg);}
function setFilter(btn,f){document.querySelectorAll('#filterRow .f-chip').forEach(b=>b.classList.remove('active'));btn.classList.add('active');activeF=f;activeListF=null;renderListFilters();render();}
function setListFilter(id){activeListF=activeListF===id?null:id;renderListFilters();render();}

async function load(){
  if (!SESSION?.familyId) return;
  try{items=await apiFetch('/items');render();updateHeader();renderListFilters();}
  catch(e){console.warn(e);}
}

async function manualRefresh(){
  const btn = document.getElementById('refreshBtn');
  if(btn){ btn.style.transform='rotate(360deg)'; btn.style.transition='transform 0.4s ease'; }
  await load();
  setTimeout(()=>{ if(btn){ btn.style.transform=''; btn.style.transition=''; } }, 400);
  toast(t('toastRefreshed'));
}
function updateHeader(){
  const o=items.filter(i=>!i.done).length;
  document.getElementById('hCount').textContent=o;
  const needed = o===1 ? t('itemNeeded') : t('itemsNeeded');
  document.getElementById('hSub').textContent=FAMILY?(FAMILY.name+' Â· '+(o===0?t('allDone'):o+' '+needed)):(o===0?t('allDone'):o+' '+needed);
}

/* â•â•â• ITEMS â•â•â• */
async function addItem(){
  if (!SESSION?.familyId){ toast(t('errJoinFirst')); openFamilyScreen(); return; }
  const name=document.getElementById('fName').value.trim();
  const note=document.getElementById('fNote').value.trim();
  if(!name){toast(t('errItemName'));return;}
  if(!selCat){toast(t('errPickCat'));return;}
  const btn=document.getElementById('submitBtn');
  btn.disabled=true;btn.textContent=t('adding');
  try{
    const item=await apiFetch('/items',{method:'POST',body:JSON.stringify({name,category:selCat,urgency:selUrg,note})});
    items.unshift(item);render();updateHeader();
    document.getElementById('fName').value='';
    document.getElementById('fNote').value='';
    toast(t('toastItemAdded')+' "'+name+'"');
    if(isMob())mobileShow('list');
  }catch(e){toast(e.message||'Something went wrong');}
  finally{btn.disabled=false;btn.textContent=t('submitBtn');}
}

const _togglePending = new Set();
function toggleDoneClick(btn){
  const id = btn.dataset.id;
  if(_togglePending.has(id)) return; // block double-tap
  const item = items.find(x=>x.id===id);
  if(!item) return;
  toggleDone(id, !item.done);
}

async function toggleDone(id, done) {
  if(_togglePending.has(id)) return;
  _togglePending.add(id);
  const i = items.findIndex(x => x.id === id);
  if (i !== -1) items[i].done = done;

  // Update card in-place â€” no re-render, no re-sort, items stay where they are
  const card = document.getElementById('c-' + id);
  if (card) {
    card.classList.toggle('done', done);
    const chk = card.querySelector('.chk');
    if (chk) { chk.classList.toggle('on', done); chk.textContent = done ? '\u2713' : ''; }
  }
  updateHeader();

  // Send immediately â€” no debounce so uncheck works right away
  try {
    await apiFetch('/items/' + id, { method: 'PATCH', body: JSON.stringify({ done }) });
  } catch(e) {
    // Revert on error
    if (i !== -1) items[i].done = !done;
    if (card) {
      card.classList.toggle('done', !done);
      const chk = card.querySelector('.chk');
      if (chk) { chk.classList.toggle('on', !done); chk.textContent = !done ? '\u2713' : ''; }
    }
    updateHeader();
    toast('Could not update â€” check your connection');
  } finally {
    _togglePending.delete(id);
  }
}

async function confDelItem(id){
  const item=items.find(i=>i.id===id);const name=item?item.name:'this item';
  const ok=await confirm2('Delete item?',`Remove "${name}"?`);if(!ok)return;
  await apiFetch('/items/'+id,{method:'DELETE'});
  items=items.filter(i=>i.id!==id);render();updateHeader();toast(t('toastItemRemoved'));
}

async function confirmClearDone(){
  const n=items.filter(i=>i.done).length;
  if(!n){toast(t('toastNoCompleted'));return;}
  const ok=await confirm2('Clear done items?',`Remove all ${n} completed item${n!==1?'s':''}?`);if(!ok)return;
  await apiFetch('/items/done/all',{method:'DELETE'});
  items=items.filter(i=>!i.done);render();updateHeader();toast(t('clearDone')+': '+n);
}

async function adminDeleteAllItems(){
  const n=items.length;
  closeAccountMenu();
  if(!n){toast(t('errNoItems'));return;}
  const ok=await confirm2('Delete ALL items?',`Permanently remove all ${n} item${n!==1?'s':''} for the whole family. This cannot be undone.`,'ğŸ—‘','Delete All');
  if(!ok)return;
  try{
    try{ await apiFetch('/items/all',{method:'DELETE'}); }
    catch{ await Promise.all(items.map(i=>apiFetch('/items/'+i.id,{method:'DELETE'}))); }
    items=[];render();updateHeader();toast('All '+n+' item'+(n!==1?'s':'')+' deleted');
  }catch(e){toast('Error: '+e.message);}
}

/* â•â•â• RENDER â•â•â• */
function renderListFilters(){
  const row=document.getElementById('listFilterRow');
  if(!serverLists.length){row.style.display='none';return;}
  row.style.display='flex';
  row.innerHTML='<span class="lf-label">'+t('myLists')+':</span>'+serverLists.map(lst=>`<button class="f-chip list-chip${activeListF===lst.id?' active':''}" onclick="setListFilter('${lst.id}')">${esc(lst.name)}</button>`).join('');
}

function render(){
  const el=document.getElementById('itemsList');
  let f=[...items];
  if(activeListF){f=f.filter(i=>i.list_id===activeListF);}
  else if(activeF==='urgent'){f=f.filter(i=>i.urgency==='urgent'&&!i.done);}
  else if(activeF!=='all'){f=f.filter(i=>i.category===activeF);}
  f.sort((a,b)=>{if(!a.done&&b.done)return -1;if(a.done&&!b.done)return 1;const o={urgent:0,normal:1,sometime:2};if(!a.done&&!b.done)return o[a.urgency]-o[b.urgency];return 0;});
  document.getElementById('resultInfo').textContent=f.length+' '+(f.length===1?t('resultItem'):t('resultItems'));
  if(!f.length){el.innerHTML=`<div class="empty"><div class="empty-icon">${activeF==='all'?'âœ“':CE[activeF]||'ğŸ”'}</div><div class="empty-title">${activeF==='all'?t('nothingNeeded'):t('nothingCategory')}</div><div class="empty-sub">${t('addItemHint')}</div></div>`;return;}
  el.innerHTML=f.map(item=>{
    if(editId===item.id)return editCard(item);
    return `<div class="item-card ${item.done?'done':''} ul-${item.urgency}" id="c-${item.id}">
      <button class="chk ${item.done?'on':''}" data-id="${item.id}" onclick="toggleDoneClick(this)">${item.done?'âœ“':''}</button>
      <div class="ic-body">
        <div class="ic-top">
          <span class="ic-name">${esc(item.name)}</span>
          <span class="cat-tag ct-${item.category}">${CE[item.category]||'ğŸ“¦'} ${t(item.category)}</span>
          <span class="urg-tag ut-${item.urgency}">${UL(item.urgency)}</span>
        </div>
        ${item.note?`<div class="ic-note">${esc(item.note)}</div>`:''}
        <div class="ic-meta"><span>${t('byLabel')} ${esc(item.who)}</span><span>Â·</span><span>${ago(item.createdAt)}</span></div>
      </div>
      <div class="ic-acts">
        <button class="ia" onclick="startEdit('${item.id}')" title="Edit">âœ</button>
        <button class="ia del" onclick="confDelItem('${item.id}')" title="Delete">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function editCard(item){return `<div class="item-card editing ul-${item.urgency}" id="c-${item.id}">
  <button class="chk ${item.done?'on':''}" data-id="${item.id}" onclick="toggleDoneClick(this)">${item.done?'âœ“':''}</button>
  <div class="ic-edit">
    <input id="ei-n" value="${esc(item.name)}" placeholder="${t('phItemName')}" maxlength="80">
    <textarea id="ei-note" rows="2" placeholder="${t('phNote')}">${esc(item.note||'')}</textarea>
    <div class="ic-edit-row">
      <select id="ei-cat">${CATS.map(c=>`<option value="${c}"${c===item.category?' selected':''}>${CE[c]} ${t(c)}</option>`).join('')}</select>
      <select id="ei-urg">${URGS.map(u=>`<option value="${u}"${u===item.urgency?' selected':''}>${UL(u)}</option>`).join('')}</select>
    </div>
    <div class="ic-edit-acts">
      <button class="btn btn-ghost" style="font-size:12px;padding:5px 11px;" onclick="cancelEdit()">${t('editCancel')}</button>
      <button class="btn btn-primary" style="font-size:12px;padding:5px 11px;" onclick="saveEdit('${item.id}')">${t('editSave')}</button>
    </div>
  </div>
</div>`;}

function startEdit(id){editId=id;render();setTimeout(()=>document.getElementById('ei-n')?.focus(),0);}
function cancelEdit(){editId=null;render();}
async function saveEdit(id){
  const name=document.getElementById('ei-n')?.value.trim();
  const note=document.getElementById('ei-note')?.value.trim()||'';
  const cat=document.getElementById('ei-cat')?.value;
  const urg=document.getElementById('ei-urg')?.value;
  if(!name){toast(t('errItemName'));return;}
  await apiFetch('/items/'+id,{method:'PATCH',body:JSON.stringify({name,note,category:cat,urgency:urg})});
  const i=items.findIndex(x=>x.id===id);if(i!==-1)items[i]={...items[i],name,note,category:cat,urgency:urg};
  editId=null;render();toast(t('toastItemUpdated'));
}

/* â•â•â• TEMPLATES (stored in localStorage â€” per device) â•â•â• */
/* â•â•â• LISTS (server-based, shared with family) â•â•â• */
let serverLists = [];
let tplItems = [], editTplId = null;

async function loadLists(){
  if (!SESSION?.familyId) return;
  try {
    serverLists = await apiFetch('/lists');
    renderSavedCards();
    renderListFilters();
  } catch(e){ console.warn(e); }
}

function addTplItem(){
  const name=document.getElementById('tiName').value.trim();
  const note=document.getElementById('tiNote').value.trim();
  const cat=document.getElementById('tiCat').value;
  const urg=document.getElementById('tiUrg').value;
  if(!name){toast(t('errItemName'));return;}
  tplItems.push({name,note,category:cat,urgency:urg});
  document.getElementById('tiName').value='';document.getElementById('tiNote').value='';
  document.getElementById('tiName').focus();
  renderTplItems();
}
function syncTpl(){
  document.querySelectorAll('#tplArea .ti-row').forEach((row,i)=>{
    if(!tplItems[i])return;
    const n=row.querySelector('.ti-n'),nt=row.querySelector('.ti-note-inp'),c=row.querySelector('.ti-c'),u=row.querySelector('.ti-u');
    if(n)tplItems[i].name=n.value.trim()||tplItems[i].name;
    if(nt)tplItems[i].note=nt.value.trim();
    if(c)tplItems[i].category=c.value;
    if(u)tplItems[i].urgency=u.value;
  });
}
function remTplItem(idx){syncTpl();tplItems.splice(idx,1);renderTplItems();}
function renderTplItems(){
  const area=document.getElementById('tplArea');
  if(!tplItems.length){area.innerHTML=`<div class="tpl-empty">${t('tplEmptyMsg')}</div>`;return;}
  area.innerHTML=tplItems.map((it,i)=>`
    <div class="ti-row">
      <div class="ti-top">
        <input class="ti-n" value="${esc(it.name)}" maxlength="80" onchange="syncTpl()" placeholder="${t('phItemName')}">
        <select class="ti-c" onchange="syncTpl()">${CATS.map(c=>`<option value="${c}"${c===it.category?' selected':''}>${CE[c]} ${cap(c)}</option>`).join('')}</select>
        <select class="ti-u" onchange="syncTpl()">${URGS.map(u=>`<option value="${u}"${u===it.urgency?' selected':''}>${UL(u)}</option>`).join('')}</select>
        <button class="ti-del" onclick="remTplItem(${i})">âœ•</button>
      </div>
      <input class="ti-note-inp" value="${esc(it.note||'')}" placeholder="Noteâ€¦" onchange="syncTpl()">
    </div>`).join('');
}

async function saveTemplate(){
  syncTpl();
  const name=document.getElementById('tplName').value.trim();
  if(!name){toast(t('errListName'));return;}
  tplItems=tplItems.filter(it=>it.name.trim());
  if(!tplItems.length){toast(t('errAddOneItem'));return;}
  const btn=document.getElementById('saveListBtn');
  btn.disabled=true;
  try {
    if(editTplId){
      await apiFetch('/lists/'+editTplId,{method:'PUT',body:JSON.stringify({name,items:tplItems})});
      editTplId=null;
      document.getElementById('listBuilderLabel').textContent=t('listBuilderNew');
      btn.textContent=t('saveListBtn');
    } else {
      await apiFetch('/lists',{method:'POST',body:JSON.stringify({name,items:tplItems})});
    }
    tplItems=[];
    document.getElementById('tplName').value='';
    renderTplItems();
    await loadLists();
    toast(t('toastListSaved')+' "'+name+'"');
  } catch(e){ toast(e.message); }
  finally { btn.disabled=false; }
}

function editTpl(id){
  const tpl=serverLists.find(x=>x.id===id);if(!tpl)return;
  editTplId=id;document.getElementById('tplName').value=tpl.name;
  document.getElementById('listBuilderLabel').textContent=t('listEditingPrefix')+tpl.name;
  document.getElementById('saveListBtn').textContent=t('updateListBtn');
  tplItems=tpl.items.map(x=>({...x}));
  renderTplItems();
  document.getElementById('sbPanelLists').scrollTo({top:0,behavior:'smooth'});
  document.getElementById('tplName').focus();
  toast(t('editListToast'));
}

async function loadTpl(id){
  const tpl=serverLists.find(x=>x.id===id);if(!tpl){toast('Not found');return;}
  if(!SESSION?.familyId){toast(t('errJoinFirst'));openFamilyScreen();return;}
  document.querySelectorAll('.sc-b-add').forEach(b=>{b.disabled=true;b.textContent=t('adding');});
  let n=0;
  for(const it of tpl.items){
    try{
      const item=await apiFetch('/items',{method:'POST',body:JSON.stringify({name:it.name,category:it.category||'other',urgency:it.urgency||'normal',note:it.note||'',list_id:tpl.id})});
      items.unshift(item);n++;
    }catch{}
  }
  render();updateHeader();
  document.querySelectorAll('.sc-b-add').forEach(b=>{b.disabled=false;b.textContent=t('addAll');});
  toast(t('addedFrom')+' '+n+' '+(n===1?t('resultItem'):t('resultItems'))+' '+t('fromList')+' "'+tpl.name+'"');
  if(isMob())mobileShow('list');
}

async function delTpl(id,name){
  const ok=await confirm2('Delete list?',`Remove "${name}"?`,'ğŸ—‘','Delete');if(!ok)return;
  try {
    await apiFetch('/lists/'+id,{method:'DELETE'});
    if(activeListF===id)activeListF=null;
    await loadLists();
    render();
    toast(t('toastListDeleted'));
  } catch(e){ toast(e.message); }
}

function togglePreview(id){const p=document.getElementById('pr-'+id);const open=p.style.display==='flex';p.style.display=open?'none':'flex';p.style.flexDirection='column';}

function renderSavedCards(){
  const el=document.getElementById('savedCards');
  if(!serverLists.length){el.innerHTML=`<div class="no-saved">${t('noSavedMsg')}</div>`;return;}
  el.innerHTML=serverLists.map(lst=>`
    <div class="sc-card">
      <div class="sc-head">
        <span class="sc-name">${esc(lst.name)}</span>
        <span class="sc-cnt">${lst.items.length} ${lst.items.length===1?t('scItem'):t('scItems')}</span>
        <div class="sc-acts">
          <button class="sc-b sc-b-add" onclick="loadTpl('${lst.id}')">${t('addAll')}</button>
          <button class="sc-b sc-b-edit" onclick="editTpl('${lst.id}')">${t('editList')}</button>
          <button class="sc-b sc-b-del"  onclick="delTpl('${lst.id}','${esc(lst.name)}')">${t('deleteList')}</button>
          <button class="sc-b sc-b-tog"  onclick="togglePreview('${lst.id}')">â–¾</button>
        </div>
      </div>
      <div class="sc-preview" id="pr-${lst.id}">
        ${lst.items.map(it=>`<div class="sc-pi">
          <span style="width:6px;height:6px;border-radius:50%;background:${UC[it.urgency||'normal']};display:inline-block;flex-shrink:0;"></span>
          <span class="sc-pi-name">${esc(it.name)}</span>
          <span style="font-size:10px;color:var(--soft);">${CE[it.category]||'ğŸ“¦'} ${t(it.category)}</span>
          ${it.note?`<span style="font-size:10px;color:var(--soft);flex:1;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(it.note)}</span>`:''}
        </div>`).join('')}
      </div>
    </div>`).join('');
}

/* â•â•â• UTILS â•â•â• */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function cap(s){return s?s[0].toUpperCase()+s.slice(1):'';}
function ago(iso){const s=Math.floor((Date.now()-new Date(iso))/1000);if(s<60)return 'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return new Date(iso).toLocaleDateString();}
function toast(msg){const el=document.createElement('div');el.className='toast';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>el.remove(),2500);}

/* â•â•â• INIT â•â•â• */
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='Enter')addItem();});
/* â•â•â• REAL-TIME LISTENER â•â•â• */
let sse = null;
function startSSE() {
  if (!SESSION?.userId || !SESSION?.familyId) return;
  if (sse) sse.close();
  sse = new EventSource(`${SRV}/events?userId=${SESSION.userId}`);
  sse.addEventListener('refresh', () => { load(); });
  sse.addEventListener('listsRefresh', () => { loadLists(); });
  sse.addEventListener('kicked', (e) => {
    const data = JSON.parse(e.data);
    document.getElementById('kickedMsg').textContent = data.reason || t('kickedDefault');
    document.getElementById('kickedTitle').textContent = t('kickedTitle');
    document.getElementById('kickedOverlay').classList.add('show');
    sse.close(); sse = null;
  });
  sse.onerror = () => {
    sse.close(); sse = null;
    setTimeout(() => { if (SESSION?.familyId) startSSE(); }, 5000);
  };
}

function handleKicked(){
  document.getElementById('kickedOverlay').classList.remove('show');
  SESSION.familyId = null;
  FAMILY = null;
  saveSession(SESSION);
  updateAccountMenu();
  updateNoFamilyBanner();
  items = []; render(); updateHeader();
  openFamilyScreen();
}
// Fallback polling every 30s in case SSE is not working
setInterval(() => { if (SESSION?.familyId && (!sse || sse.readyState === 2)) load(); }, 30000);

(async function init(){
  // Load saved language preference
  const savedLang = localStorage.getItem('fl_lang') || 'en';
  LANG = savedLang;
  document.documentElement.lang = savedLang;
  document.documentElement.dir = savedLang === 'he' ? 'rtl' : 'ltr';
  applyTranslations();

  SESSION = getSession();
  if (!SESSION) {
    // No saved session â€” show login straight away
    document.getElementById('authScreen').classList.remove('hidden');
    return;
  }
  // We have a saved session â€” verify it's still valid silently in background
  try {
    const { user, family } = await apiFetch('/auth/me');
    SESSION = { userId: user.id, name: user.name, email: user.email, familyId: user.family_id };
    FAMILY = family;
    saveSession(SESSION);
    onLoggedIn();
  } catch {
    // Session expired or invalid â€” clear it and show login
    clearSession();
    document.getElementById('authScreen').classList.remove('hidden');
  }
})();
</script>
</body>
</html>